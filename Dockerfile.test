# syntax=docker/dockerfile:1

FROM dhi.io/python:3-debian13-dev AS build-stage

ENV LANG=C.UTF-8
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PATH="/app/venv/bin:$PATH"

WORKDIR /app
COPY requirements.txt requirements-test.txt ./

RUN python -m venv /app/venv

RUN pip install --no-cache-dir -r ./requirements.txt
RUN pip install --no-cache-dir -r ./requirements-test.txt

# Install ansible in the venv
RUN pip install --no-cache-dir ansible

FROM dhi.io/python:3-debian13-sfw-dev AS runtime-stage

RUN apt update -y && apt install git openssh-client sshpass docker.io -y

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PATH="/app/venv/bin:$PATH"

WORKDIR /app

COPY --from=build-stage /app/venv /app/venv
COPY /app ./app
COPY pyproject.toml .

# Install ansible collections
RUN ansible-galaxy collection install vultr.cloud community.general community.docker community.crypto

# Create directories that symlinks will target
RUN mkdir -p /inventory /outputs /data /services

# Install Playwright browsers for browser tests
RUN playwright install --with-deps chromium || true

ENTRYPOINT ["python", "-m", "pytest"]
CMD ["tests/", "-v", "--tb=short", "-m", "not e2e and not playwright"]
